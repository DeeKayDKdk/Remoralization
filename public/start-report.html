<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Start Your Report</title>

<!-- Theme (matches your main page) -->

<style>
:root{
--bg:#0f1220; /* page background */
--panel:#1b2034; /* card background */
--text:#e9eefb; /* body text */
--muted:#9bb1c7; /* secondary text */
--accent:#ffd233; /* yellow brand */
--ink:#111; /* black on yellow */
--ring: rgba(255,210,51,.45);
--border:#242b44;
--glass: rgba(255,255,255,.06);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
margin:0;
color:var(--text);
background:
radial-gradient(1200px 600px at 20% -10%, #222a48 0%, transparent 60%),
radial-gradient(1000px 600px at 90% -20%, #1b2034 0%, transparent 60%),
var(--bg);
font:16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.wrap{
min-height:100%;
display:grid;
place-items:start center;
padding:32px 18px 64px;
}
.card{
width:min(900px, 94vw);
background: linear-gradient(180deg, #1b2034, #151a2b);
border:1px solid var(--border);
border-radius:16px;
padding:28px;
box-shadow: 0 12px 40px rgba(0,0,0,.35), inset 0 1px 0 var(--glass);
}

h1{
margin:0 0 8px;
font-size:clamp(26px, 3.2vw, 40px);
letter-spacing:.2px;
}
.meta{
color:var(--muted);
font-size:.95rem;
margin-bottom:22px;
}

.grid {
display: grid;
gap: 16px;
grid-template-columns: 1fr; /* one column only */
}
@media (max-width: 880px){
.grid{ grid-template-columns:1fr 1fr; }
}
@media (max-width: 560px){
.grid{ grid-template-columns:1fr; }
}

.field{
background: rgba(255,255,255,.03);
border:1px solid #2e3654;
border-radius:12px;
padding:14px 14px 10px;
transition:border-color .15s, box-shadow .15s;
}
.label{
display:block;
color:var(--muted);
font-weight:700;
font-size:.92rem;
margin:0 0 8px;
}
input[type="number"], input[type="text"], textarea{
width:100%;
color:var(--text);
background:#0f1426;
border:1px solid #2e3654;
border-radius:10px;
padding:12px 14px;
outline:none;
transition:border-color .15s, box-shadow .15s;
}
input:focus, textarea:focus{
border-color:var(--accent);
box-shadow:0 0 0 4px var(--ring);
}

textarea{
min-height:160px;
resize:vertical;
}

.note{
color:var(--muted);
margin-top:6px;
font-size:.9rem;
}

.actions{
display:flex;
gap:12px;
align-items:center;
margin-top:18px;
flex-wrap:wrap;
}
.btn{
display:inline-block;
border-radius:12px;
padding:12px 18px;
font-weight:800;
border:1px solid transparent;
text-decoration:none;
cursor:pointer;
user-select:none;
transition:transform .045s ease, filter .12s, box-shadow .12s, background .12s;
}
.btn:active{ transform:translateY(1px) }

.btn-primary{
background:var(--accent);
color:var(--ink);
box-shadow: 0 10px 24px rgba(255,210,51,.25);
}
.btn-primary:hover{ filter:saturate(1.05) brightness(1.02) }
.btn-ghost{
background:transparent;
color:var(--text);
border-color:#2e3654;
}

.msg{ margin-top:14px; font-weight:700 }
.msg.ok{ color:#22cc88 }
.msg.err{ color:#ff5577 }

/* little divider card for the narrative */
.section{
margin-top:18px;
padding-top:6px;
border-top:1px solid #232842;
}
  .note {
margin-top: 6px;
color: var(--muted, #c9c9c9);
font-size: .92rem;
}

button[disabled] {
opacity: .6;
cursor: not-allowed;
filter: saturate(.5);
}
</style>
</head>
<body>
<div class="wrap">
<div class="card">
<h1>Start Your Report</h1>
<div class="meta" id="periodMeta">Signed in as ‚Ä¢ Period: </div>

<!-- Scores grid -->
<div class="grid">
<div class="field">
<label class="label" for="pd_note">Physical Discipline</label>
<textarea id="pd_note" class="tarea" placeholder="What training, sleep, or nutrition wins did you have? Where did discipline slip? What‚Äôs the one improvement you‚Äôll make next?"></textarea>
</div>

<div class="field">
<label class="label" for="ro_note">Responsibility to Others</label>
<textarea id="ro_note" class="tarea" placeholder="How did you show up for family, friends, team, or community? What do you regret not doing? What will you do differently?"></textarea>
</div>

<div class="field">
<label class="label" for="bm_note">Belief & Morality</label>
<textarea id="bm_note" class="tarea" placeholder="What principles guided your choices? Any moments you compromised or stood firm? One concrete way to align actions and values next."></textarea>
</div>

<div class="field">
<label class="label" for="sm_note">Skill & Mastery</label>
<textarea id="sm_note" class="tarea" placeholder="What skills did you practice or ship? Where did you get stuck? What‚Äôs the next deliberate practice or milestone?"></textarea>
</div>

<div class="field">
<label class="label" for="sr_note">Self-Reliance</label>
<textarea id="sr_note" class="tarea" placeholder="Where did you solve problems independently? Where did dependency creep in? What‚Äôs one system or preparation you‚Äôll add?"></textarea>
</div>

<div class="field">
<label class="label" for="ic_note">Integrity & Consistency</label>
<textarea id="ic_note" class="tarea" placeholder="Did your actions match your word? Where did you drift? What small daily habit will lock integrity in?"></textarea>
</div>
</div>
<!-- Narrative -->
<div class="section field" style="margin-top:22px;">
<label class="label" for="notes">Narrative / Reflection</label>
<textarea id="notes" placeholder="What went well? What needs work? What‚Äôs one explicit commitment for the next two weeks?"></textarea>
<small class="note" id="cooldownNote"></small>
</div>

<!-- Actions -->
<!-- Success + Countdown placeholders -->
<div id="msg" class="msg"></div>
<div id="cooldownNote" class="note"></div>

<!-- Actions -->
<div class="actions">
<button id="saveBtn" class="btn btn-primary">Save Report</button>
<a class="btn btn-ghost" href="/">Back to Home</a>
</div>

<!-- (Optional) Hook up period text + cooldown display if you already compute these in JS -->
<script>
// Example: set the period line dynamically if you have start/end dates available
// document.getElementById('periodMeta').textContent =
// `Signed in as ${email} ‚Ä¢ Period: ${periodStart} ‚Üí ${periodEnd}`;

// Example: show a cooldown note if you‚Äôre enforcing 14-day spacing server-side
// const msLeft = /* compute ms until next allowed report */ 0;
// const cd = document.getElementById('cooldownNote');
// if (msLeft > 0) {
// const days = Math.floor(msLeft / 86400000);
// const hours = Math.floor((msLeft % 86400000) / 3600000);
// cd.textContent = `Next report available in ${days}d ${hours}h.`;
// }

// Wire your existing save logic to #saveBtn and the field IDs above.
// On success: msg('Saved ‚úî', true) ; on error: msg('Error ‚Ä¶', false)
function msg(text, ok){
const m = document.getElementById('msg');
m.textContent = text;
m.className = 'msg ' + (ok ? 'ok' : 'err');
}
</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// üîß Replace these with your Supabase project values
const SUPABASE_URL = 'https://qsvelfkcaaqxgaewwwog.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (s)=>document.querySelector(s);

function msg(text, ok=true){
const el = $('#msg'); if(!el) return;
el.textContent = text;
el.className = 'msg ' + (ok ? 'ok':'err');
}

function gatherForm(){
return {
physical: $('#pd_note')?.value?.trim() || '',
others: $('#ro_note')?.value?.trim() || '',
morality: $('#bm_note')?.value?.trim() || '',
mastery: $('#sm_note')?.value?.trim() || '',
selfreliance: $('#sr_note')?.value?.trim() || '',
integrity: $('#ic_note')?.value?.trim() || '',
notes: $('#notes')?.value?.trim() || ''
};
}

// ‚è≥ countdown helpers
const DAY = 86400000;
const COOLDOWN_MS = 13 * DAY; // 13 days
function startCountdown(){
const cdEl = $('#cooldownNote'), btn = $('#saveBtn');
const target = parseInt(localStorage.getItem('nextReportAt'),10);
if(!cdEl || !target) return;

function update(){
const left = target - Date.now();
if (left <= 0){
cdEl.textContent = "üéâ You can submit a new report now.";
btn?.removeAttribute('disabled');
clearInterval(t);
return;
}
const d = Math.floor(left / DAY);
const h = Math.floor((left % DAY) / 3600000);
const m = Math.floor((left % 3600000) / 60000);
cdEl.textContent = `‚è≥ Next report in ${d}d ${h}h ${m}m`;
btn?.setAttribute('disabled','true'); // block during cooldown
}

update();
const t = setInterval(update, 60000); // update every minute
}

async function saveReport(){
const btn = $('#saveBtn');
btn?.setAttribute('disabled','true');
msg('Saving‚Ä¶');

// must be logged in
const { data:{ user }, error:authErr } = await supabase.auth.getUser();
if(authErr || !user){ msg('Please sign in first.', false); btn?.removeAttribute('disabled'); return; }

// send to DB (expects a JSONB column "form_data" in public.reports)
const payload = {
user_id: user.id,
pillar_scores: gatherForm(), // goes into JSONB
narrative: document.getElementById('notes')?.value.trim() || '', // goes into text
period_start: new Date().toISOString().slice(0, 10),
period_end: new Date(Date.now() + 13 * 86400000).toISOString().slice(0, 10)
};

const { data, error } = await supabase
.from('reports')
.insert(payload)
.select('id')
.single();

if (error) {
msg('Error saving: ' + error.message, false);
btn?.removeAttribute('disabled');
return;
} else {
console.log("Report inserted with id:", data.id);
}

// success + start cooldown
msg('‚úÖ Report saved! You‚Äôll receive a human response within 48 hours.', true);
const next = Date.now() + COOLDOWN_MS;
localStorage.setItem('nextReportAt', String(next));
startCountdown();
}

document.addEventListener('DOMContentLoaded', () => {
$('#saveBtn')?.addEventListener('click', saveReport);
if(localStorage.getItem('nextReportAt')) startCountdown();
});
</script>
</body>
</html>

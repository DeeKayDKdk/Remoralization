<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Start Your Report</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===== Theme (matches your main page) ===== */
:root{
--bg:#0f1220; /* page background */
--panel:#1b2034; /* card background */
--text:#9ee0fb; /* body text */
--muted:#9bb3c9; /* secondary text */
--accent:#e2a355; /* yellow brand */
--ink:#111; /* black on yellow */
--glass: rgba(255,255,255,.04);
--border: rgba(235,235,251,.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
margin:0; color:var(--text);
background:
radial-gradient(1200px 600px at 20% -10%, #222a48 0%, transparent 60%),
radial-gradient(1000px 600px at 90% -20%, #1b2034 0%, transparent 60%),
var(--bg);
font:16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
.wrap{min-height:100%; display:grid; place-items:start center; padding:32px 10px 64px}
.card{
width:min(980px, 94vw);
background: linear-gradient(185deg, #1b2034, #151a2b);
border:1px solid var(--border);
border-radius:16px; padding:28px;
box-shadow: 0 12px 40px rgba(0,0,0,.35), inset 0 1px 0 var(--glass);
}
h1{margin:0 0 10px; font-size:clamp(26px, 3.2vw, 40px); letter-spacing:.2px}
.meta{color:var(--muted); font-size:.95rem; margin-bottom:22px}
.grid{display:grid; gap:16px}
@media (min-width:880px){ .grid{grid-template-columns:1fr 1fr} }
.field{background:rgba(255,255,255,.03); border:1px solid #2e3654; border-radius:12px; padding:14px 14px 10px}
.label{display:block; color:var(--muted); font-weight:700; font-size:.92rem; margin:0 0 8px}
input[type="number"], input[type="text"], textarea, select{
width:100%; color:var(--text); background:#0f1426; border:1px solid #2e3654;
border-radius:10px; padding:12px 14px; outline:none; transition:border-color .15s, box-shadow .15s;
}
input:focus, textarea:focus, select:focus{ border-color:var(--accent); box-shadow:0 0 4px var(--accent) }
textarea{min-height:140px; resize:vertical}
.actions{display:flex; gap:12px; align-items:center; margin-top:18px; flex-wrap:wrap}
.btn{display:inline-block; border-radius:12px; padding:12px 18px; font-weight:800; border:1px solid transparent; text-decoration:none; cursor:pointer; user-select:none; transition:transform .045s ease, filter .12s, box-shadow .12s, background .12s}
.btn:active{transform:translateY(1px)}
.btn-primary{ background:var(--accent); color:var(--ink); box-shadow:0 10px 24px rgba(255,210,51,.25) }
.btn-ghost{ background:transparent; color:var(--text); border-color:#2e3654 }
.msg{ margin-top:14px; font-weight:700 }
.msg.ok{ color:#22cc88 } .msg.err{ color:#ff5577 }
.note{ color:var(--muted); font-size:.9rem; margin: 6px 0 12px }

/* WHY hero strip */
.report-hero { text-align:center; background: linear-gradient(145deg, #1c1c1c, #2a2a2a); color:#f5f5f5; padding: 18px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,.4); margin: 8px 0 18px }
.report-hero h2{ margin: 0 0 6px; color:#ff4dad }
.prefs{display:grid; gap:12px}
@media (min-width:880px){ .prefs{grid-template-columns: 1.2fr .8fr} }

/* Drag list */
.rank { list-style:none; padding:0; margin:0; display:grid; gap:8px }
.rank li{ background:#121735; border:1px dashed #334; border-radius:10px; padding:10px 12px; cursor:grab; font-weight:700 }
.rank li.dragging{ opacity:.5 }

/* small chips */
.chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
.chip{ background:#18224a; border:1px solid #2e3654; padding:6px 10px; border-radius:999px; font-size:.85rem }

/* inline badges */
.badge{ display:inline-block; padding:4px 8px; border-radius:8px; background:#0e1733; border:1px solid #24305a; color:#8fb9ff; font-size:.8rem }
</style>
</head>
<body>
<div class="wrap">
<div class="card">
<!-- Header -->
<h1>Start Your Report. Sharpen Your Edge.</h1>
<div class="meta">
<span id="periodMeta">Signed in as ‚Äì Period: ‚Äî</span>
<span class="badge" id="cooldownNote" style="margin-left:8px"></span>
</div>

<!-- WHY + Reminder / Scheduling -->
<div class="report-hero">
<h2>Your WHY</h2>
<p style="margin:0 0 10px">Anchor your actions to something intrinsic. We‚Äôll save this with your report and use it in reminders.</p>
<div class="prefs">
<div class="field">
<label class="label" for="why_text">Why are you doing this?</label>
<textarea id="why_text" placeholder="Write the reason that makes discipline worth it. Who/what are you protecting or building for?"></textarea>
<div class="chips">
<span class="chip">Family</span><span class="chip">Health</span><span class="chip">Service</span>
<span class="chip">Mastery</span><span class="chip">Freedom</span><span class="chip">Legacy</span>
</div>
<div class="note">Tip: short, specific, and felt. You‚Äôll see it in your weekly reminder.</div>
</div>

<div class="field">
<label class="label">Reminders & Check-ins</label>
<div class="grid" style="grid-template-columns:1fr">
<button id="addWhyCalendar" class="btn btn-ghost">‚ûï Add Weekly WHY to Calendar (.ics)</button>
<button id="enableNotify" class="btn btn-ghost">üîî Enable Browser Notifications</button>
<button id="bookCall" class="btn btn-ghost">üìπ Book 20-min Check-in (1x / 2 weeks)</button>
<a id="mailtoWhy" class="btn btn-ghost" href="#" target="_blank">‚úâÔ∏è Email my WHY to myself</a>
<div class="note">We‚Äôll nudge you the day <b>before</b> your period ends and on the <b>day of</b>. Calendar + notifications keep you honest.</div>
</div>
</div>
</div>
</div>

<!-- Pillar textareas (unchanged content; ids preserved) -->
<div class="grid">
<div class="field">
<label class="label" for="pd_note">Physical Discipline</label>
<textarea id="pd_note" placeholder="Training, sleep, or nutrition wins? Where did discipline slip? What‚Äôs the one improvement you‚Äôll make next?"></textarea>
</div>
<div class="field">
<label class="label" for="ro_note">Responsibility to Others</label>
<textarea id="ro_note" placeholder="How did you show up for family, friends, team, or community? What will you do differently?"></textarea>
</div>
<div class="field">
<label class="label" for="bm_note">Belief & Morality</label>
<textarea id="bm_note" placeholder="What principles guided your choices? Any moments you compromised or stood firm? One concrete way to align actions and values next."></textarea>
</div>
<div class="field">
<label class="label" for="sm_note">Skill & Mastery</label>
<textarea id="sm_note" placeholder="What skills did you practice or ship? Where did you get stuck? What‚Äôs the next deliberate practice or milestone? "></textarea>
</div>
<div class="field">
<label class="label" for="sr_note">Self-Reliance</label>
<textarea id="sr_note" placeholder="Where did you solve problems independently? Any dependency? One system or preparation you‚Äôll add next. "></textarea>
</div>
<div class="field">
<label class="label" for="ic_note">Integrity & Consistency</label>
<textarea id="ic_note" placeholder="Did your actions match your word? Where did you drift? What small daily habit will lock integrity in place? "></textarea>
</div>
<div class="field" style="grid-column:1/-1">
<label class="label" for="notes">Narrative / Reflection</label>
<textarea id="notes" placeholder="What went well? What needs work? One explicit commitment for the next two weeks."></textarea>
</div>
</div>

<!-- Rank Order (drag & drop) -->
<div class="field" style="margin-top:14px">
<label class="label">Rank which pillar you need most help with (top = needs most help)</label>
<ul id="rankList" class="rank">
<li draggable="true" data-key="physical">Physical Discipline</li>
<li draggable="true" data-key="others">Responsibility to Others</li>
<li draggable="true" data-key="morality">Belief & Morality</li>
<li draggable="true" data-key="mastery">Skill & Mastery</li>
<li draggable="true" data-key="selfReliance">Self-Reliance</li>
<li draggable="true" data-key="integrity">Integrity & Consistency</li>
</ul>
<div class="note">Drag to reorder. We‚Äôll tailor your action plan to your top 1‚Äì2.</div>
</div>

<!-- Action plan (auto-generated) -->
<div class="field">
<label class="label">Suggested Action Plan (auto)</label>
<div id="planBox" class="note">When you save, we‚Äôll generate 3 concrete next steps from your entries.</div>
</div>

<!-- Actions -->
<div class="actions">
<button id="saveBtn" class="btn btn-primary">Save Report</button>
<a class="btn btn-ghost" href="/index.html">Back to Home</a>
<span id="msg" class="msg"></span>
</div>

<div class="note">By saving you agree to store this report securely. You‚Äôll receive a human response within 48 hours.</div>
</div>
</div>

<!-- ===== Scripts ===== -->
<script>
/** === CONFIG ‚Äì replace with your values === **/
const SUPABASE_URL = "https://qsvelfkcaaqxgaewwwog.supabase.co"; // ‚Üê replace
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ"; // ‚Üê replace
const CAL_BOOKING_URL = "https://cal.com/your-handle/20-min-checkin"; // ‚Üê replace (or Calendly)

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** === tiny helpers === */
const $ = (sel, ctx=document) => ctx.querySelector(sel);
const $$ = (sel, ctx=document) => [...ctx.querySelectorAll(sel)];
function msg(text, ok=true){ const el=$("#msg"); if(!el) return; el.textContent=text; el.className="msg "+(ok?"ok":"err"); }
function userEmailFallback(){ return (window._cachedUser && window._cachedUser.email) || ""; }

/** === auth + period meta (uses your prior 14-day cooldown scent) === */
const DAY = 86400000, COOLDOWN_MS = 13 * DAY; // 13 days block; show ‚Äúperiod end‚Äù on day 14
let nextReportAt = Number(localStorage.getItem("nextReportAt")||0);

async function boot(){
// who‚Äôs signed in
const { data: { user }, error } = await supabase.auth.getUser();
window._cachedUser = user || null;

const meta = $("#periodMeta");
if (user) {
const start = new Date(); // start now for display
const end = new Date(Date.now() + 14*DAY);
meta.textContent = `Signed in as ${user.email} ¬∑ Period: ${start.toISOString().slice(0,10)} ‚Üí ${end.toISOString().slice(0,10)}`;
} else {
meta.textContent = "Not signed in";
}

// cooldown text + notifications check
if (nextReportAt) startCountdown();
setupReminderButtons();
setupRankDrag();
setupMailto();
}
document.addEventListener("DOMContentLoaded", boot);

/** === Calendar file (.ics) for weekly WHY === */
function makeICS({title, description, startDate, hours=9, minutes=0}){
const dt = new Date(startDate);
dt.setHours(hours, minutes, 0, 0);
const pad = n=>String(n).padStart(2,"0");
const stamp = (d)=>(
d.getUTCFullYear()+
pad(d.getUTCMonth()+1)+
pad(d.getUTCDate())+"T"+
pad(d.getUTCHours())+
pad(d.getUTCMinutes())+
pad(d.getUTCSeconds())+"Z"
);
const now = stamp(new Date());
const dtstart = stamp(dt);
const dtend = stamp(new Date(dt.getTime()+30*60000)); // 30min

const ics = [
"BEGIN:VCALENDAR",
"VERSION:2.0",
"PRODID:-//Remoralization//WHY Weekly//EN",
"BEGIN:VEVENT",
"UID:"+crypto.randomUUID(),
"DTSTAMP:"+now,
"DTSTART:"+dtstart,
"DTEND:"+dtend,
"RRULE:FREQ=WEEKLY",
"SUMMARY:"+title,
"DESCRIPTION:"+description.replace(/\n/g,"\\n"),
"END:VEVENT",
"END:VCALENDAR"
].join("\r\n");

const blob = new Blob([ics], {type:"text/calendar"});
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url; a.download = "why-weekly.ics"; a.click();
setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

/** === Notifications: day-before + day-of period end === */
function setupReminderButtons(){
$("#addWhyCalendar").addEventListener("click", ()=>{
const why = ($("#why_text").value || "Remember your WHY.");
makeICS({
title:"WHY Reminder",
description: why,
startDate: new Date() // first reminder now; RRULE weekly
});
});

$("#enableNotify").addEventListener("click", async ()=>{
if (!("Notification" in window)) { msg("Notifications not supported in this browser.", false); return; }
const perm = await Notification.requestPermission();
if (perm !== "granted") { msg("Enable notifications to get period reminders.", false); return; }
localStorage.setItem("notify_ok","1");
msg("Notifications enabled. We‚Äôll check daily for ‚Äòday-before‚Äô & ‚Äòday-of‚Äô alerts.", true);
});

// check daily for period reminders
scheduleDailyCheck();
}
function scheduleDailyCheck(){
// run now + every 6 hours
checkPeriodAlerts();
setInterval(checkPeriodAlerts, 6*60*60*1000);
}
function notifyOnce(key, title, body){
if (localStorage.getItem(key)) return;
if (localStorage.getItem("notify_ok")==="1" && "Notification" in window && Notification.permission==="granted"){
new Notification(title, { body });
localStorage.setItem(key, String(Date.now()));
}
}
function checkPeriodAlerts(){
if (!nextReportAt) return;
const end = Number(nextReportAt); // ‚Äúnext report allowed at‚Äù timestamp
const dayBefore = end - DAY;
const now = Date.now();
if (now >= dayBefore && now < end) {
notifyOnce("alert_day_before", "Report tomorrow", "Your 2-week period ends tomorrow. Finish strong and line up your next actions.");
}
if (now >= end) {
notifyOnce("alert_day_of", "Report today", "Your 2-week period ends today. Submit your report and book your check-in.");
}
}

/** === Cal/Calendly booking guard (1x / 2 weeks) === */
function setupMailto(){
const a = $("#mailtoWhy");
a.addEventListener("click", (e)=>{
e.preventDefault();
const subject = encodeURIComponent("My WHY (reminder)");
const body = encodeURIComponent(($("#why_text").value||"")+"\n\n‚Äî sent from Remoralization");
const email = userEmailFallback() || "";
window.open(`mailto:${encodeURIComponent(email)}?subject=${subject}&body=${body}`, "_blank");
});
}
$("#bookCall").addEventListener("click", (e)=>{
e.preventDefault();
const last = Number(localStorage.getItem("lastBookingAt")||0);
const okAt = (last||0) + (14*DAY);
if (Date.now() < okAt) {
const days = Math.ceil((okAt - Date.now())/DAY);
msg(`You already booked a check-in. You can book again in ~${days} day(s).`, false);
return;
}
const email = encodeURIComponent(userEmailFallback());
const link = `${CAL_BOOKING_URL}?email=${email}`;
window.open(link, "_blank");
localStorage.setItem("lastBookingAt", String(Date.now()));
msg("Booking link opened in a new tab.", true);
});

/** === Drag & drop rank === */
function setupRankDrag(){
const list = $("#rankList");
let dragEl = null;
list.addEventListener("dragstart", (e)=>{ dragEl = e.target; dragEl.classList.add("dragging"); });
list.addEventListener("dragend", (e)=>{ if(dragEl){ dragEl.classList.remove("dragging"); dragEl=null; }});
list.addEventListener("dragover", (e)=>{
e.preventDefault();
const after = [...list.querySelectorAll("li:not(.dragging)")].find(li => e.clientY <= li.getBoundingClientRect().top + li.offsetHeight/2);
if (!dragEl) return;
if (after) list.insertBefore(dragEl, after); else list.appendChild(dragEl);
});
}
function getRankOrder(){
return $$("#rankList li").map(li => li.getAttribute("data-key"));
}

/** === Countdown & cooldown UI (keeps your original behavior) === */
function startCountdown(){
const cEl = $("#cooldownNote"), btn=$("#saveBtn");
function update(){
const left = nextReportAt - Date.now();
if (left <= 0){ cEl.textContent = "You can submit a new report now."; btn.removeAttribute("disabled"); return; }
const d = Math.floor(left / DAY), h = Math.floor((left % DAY) / 3600000);
cEl.textContent = `Next report in ${d}d ${h}h`;
btn.setAttribute("disabled", "true");
}
update();
setInterval(update, 60000);
}

/** === Gather & plan === */
function gatherForm(){
return {
why: ($("#why_text").value || "").trim(),
physical: ($("#pd_note").value||"").trim(),
others: ($("#ro_note").value||"").trim(),
morality: ($("#bm_note").value||"").trim(),
mastery: ($("#sm_note").value||"").trim(),
selfReliance: ($("#sr_note").value||"").trim(),
integrity: ($("#ic_note").value||"").trim(),
narrative: ($("#notes").value||"").trim(),
rank: getRankOrder()
};
}

// simple plan generator (1‚Äì3 steps)
function makePlan(form){
const pick = (txt)=> (txt||"").split(/\n|\. |- /).map(s=>s.trim()).filter(Boolean)[0] || null;
const top = (form.rank && form.rank[0]) || "physical";
const map = {
physical: ["Block 3√ó 45-min training sessions in your calendar.", "Pre-log meals for 3 days.", "Set sleep cutoff alarm at 10:00pm."],
others: ["Schedule one deliberate act of service this week.", "Send 2 ‚Äòthank-you & update‚Äô messages.", "Plan a family/mentor check-in."],
morality: ["Copy one guiding principle where you‚Äôll see it daily.", "Choose one temptation guardrail for next 2 weeks.", "Do one integrity audit of a routine."],
mastery: ["Define one drill you‚Äôll practice 5√ó this week.", "Ship a tiny demo by next Friday.", "Book a 20-min feedback review."],
selfReliance:["Replace 1 outsourced task with self-sufficiency.", "Batch prep for the hardest day ahead.", "Create a basic checklist for that recurring task."],
integrity: ["Pick one micro-habit you‚Äôll never miss (2 min).", "Track streak daily (no zero days).", "Reduce scope; keep the promise."]
};
const seed = pick(form[top]);
const base = map[top];
const steps = [];
if (seed) steps.push(`1) ${seed}`);
steps.push(...base.slice(0, 3 - steps.length));
return { top, steps };
}

/** === Save === */
async function saveReport(){
const btn = $("#saveBtn");
btn.setAttribute("disabled","true");
msg("Saving‚Ä¶");

// must be logged in
const { data: { user }, error:authErr } = await supabase.auth.getUser();
if (authErr || !user){ msg("Please sign in first.", false); btn.removeAttribute("disabled"); return; }

const form = gatherForm();
const plan = makePlan(form);
$("#planBox").innerHTML = `<div><b>Top focus:</b> ${plan.top.replace(/([A-Z])/g," $1")}</div><ul>${plan.steps.map(s=>`<li>${s}</li>`).join("")}</ul>`;

// send to DB (store new fields inside JSONB)
const payload = {
user_id: user.id,
pillar_scores: form, // JSONB
narrative: form.narrative,
action_plan: plan, // JSONB
period_start: new Date().toISOString().slice(0,10),
period_end: new Date(Date.now() + 13*DAY).toISOString().slice(0,10) // display end (day 14)
};

const { data, error } = await supabase
.from("reports")
.insert(payload)
.select("id")
.single();

if (error){ msg("Error saving: "+error.message, false); btn.removeAttribute("disabled"); return; }

// success ‚Üí start cooldown + reminders
nextReportAt = Date.now() + COOLDOWN_MS;
localStorage.setItem("nextReportAt", String(nextReportAt));
localStorage.removeItem("alert_day_before");
localStorage.removeItem("alert_day_of");
startCountdown();
checkPeriodAlerts();

msg("Report saved! You‚Äôll receive a human response within 48 hours.", true);
}
$("#saveBtn").addEventListener("click", saveReport);

/** === Prefill tiny conveniences === */
document.addEventListener("click", (e)=>{
if (e.target.classList.contains("chip")) {
const t = $("#why_text");
t.value = (t.value ? t.value+"\n" : "") + e.target.textContent;
}
});
</script>
</body>
</html>

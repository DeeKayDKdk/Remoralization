<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Platinum Dashboard ‚Ä¢ Operation Remoralization</title>

<!-- font (small, fast) -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
--bg:#0f1220; --card:#1c2233; --muted:#9fb3c8; --text:#eaf2ff; --accent:#f2a355;
--good:#2ea35c; --bad:#ff6b6b; --ring:rgba(255,255,255,.08); --shadow:0 30px 80px rgba(0,0,0,.45);
--radius:14px;
}

* { box-sizing:border-box }
html, body { height:100% }
body {
margin:0; color:var(--text);
background:
radial-gradient(1200px at 10% 20%, #182036, transparent 60%),
radial-gradient(900px at 90% 10%, #241a05, transparent 55%),
var(--bg);
font:16px/1.6 "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
}

.wrap { max-width:1040px; margin:48px auto; padding:20px }
.title { margin:0 0 8px; font-weight:800; font-size:34px; line-height:1.15 }
.subtitle{ margin:8px 0 20px; opacity:.75 }

.grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); margin-top:20px }
.card {
background:rgba(255,255,255,.04);
border:1px solid var(--ring);
border-radius:var(--radius);
box-shadow:var(--shadow);
padding:20px;
}

.kpi { margin:0 0 6px; font-size:20px; letter-spacing:.5px }
.row { display:flex; gap:12px; align-items:center }
.row .note{ opacity:.9; font-style:italic }

.btn {
display:inline-block; padding:12px 18px; border-radius:10px; border:1px solid var(--ring);
text-decoration:none; font-weight:700; box-shadow:0 4px 18px rgba(0,0,0,.25); background:rgba(255,255,255,.04); color:var(--text);
}
.btn-primary { background: #f2a355; color:#101418; border-color:transparent }
.btn-ghost { background: transparent; color:#e0f0ff; border-color:#8a820e }
.btn-danger { background:#ff6b6b; color:#101418; border-color:transparent }

.right { margin-left:auto }
.status { display:none; margin-top:12px; padding:12px 16px; border-radius:10px; border:1px dashed #7a86a5; background:rgba(255,255,255,.06) }
.status.ok { border-color:var(--good) }
.status.bad { border-color:var(--bad) }

canvas#fx { position:fixed; inset:0; pointer-events:none }
</style>
</head>

<body>
<canvas id="fx"></canvas>

<div class="wrap">
<div class="card">
<div class="row">
<div>
<h1 class="title">Platinum Dashboard</h1>
<p class="subtitle">Welcome back. This hub is just for Platinum members.</p>
</div>
<div class="right row">
<button id="billingBtn" class="btn btn-ghost">Open Billing Portal</button>
<a id="logoutBtn" class="btn btn-danger" href="/login.html">Log out</a>
</div>
</div>

<div class="grid">
<div class="card">
<h3 class="kpi">Daily check-in</h3>
<p id="checkMsg" class="note">Mark today‚Äôs check-in to keep momentum.</p>
<div class="row">
<button id="checkinBtn" class="btn btn-primary">Mark today‚Äôs check-in</button>
</div>
</div>

<div class="card">
<h3 class="kpi">Current streak</h3>
<p><span id="streak">‚Äì</span><span> days</span></p>
</div>
</div>

<div class="grid" style="margin-top:20px">
<div class="card">
<h3 class="kpi">Quick Actions</h3>
<div class="row"><a id="book101" class="btn btn-ghost" target="_blank" rel="noopener">Book 1:1 Review</a></div>
<div class="row"><a class="btn btn-ghost" href="mailto:support@yourdomain.com">Contact Support</a></div>
<div class="row"><a class="btn btn-ghost" href="/platinum/challenges.html">View Challenges</a></div>
<div class="row"><a class="btn btn-ghost" href="/platinum/resources.html">Open Resources</a></div>
<div class="row"><a class="btn btn-ghost" href="/platinum/community.html">Enter Community</a></div>
</div>
</div>

<div id="status" class="status"></div>
</div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =========================
üîß CONFIG ‚Äì put your real values
========================= */
const SUPABASE_URL = "https://qsvelfkcaaxgxgaewwwog.supabase.co"; // <-- your real URL
const SUPABASE_ANON_KEY= "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ"; // <-- your real anon key

// Safety guard to prevent the ‚ÄúInvalid supabaseUrl‚Äù crash
if (!/^https?:\/\//.test(SUPABASE_URL)) {
document.body.innerHTML =
'<main style="max-width:720px;margin:48px auto;padding:24px;color:#eaf2ff;">' +
'<h2>Config error</h2><p>SUPABASE_URL is not a valid http(s) URL.</p></main>';
throw new Error('SUPABASE_URL invalid');
}

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
üîå ELEMENTS
========================= */
const statusBox = document.getElementById('status');
const streakEl = document.getElementById('streak');
const checkBtn = document.getElementById('checkinBtn');
const checkMsg = document.getElementById('checkMsg');
const bookBtn = document.getElementById('book101');
const billingBtn= document.getElementById('billingBtn');
const logoutBtn = document.getElementById('logoutBtn');

/* =========================
üß≠ HELPERS
========================= */
function showStatus(html, tone='ok', sticky=false){
statusBox.className = 'status ' + (tone === 'ok' ? 'ok' : 'bad');
statusBox.innerHTML = html;
statusBox.style.display = 'block';
if (!sticky) setTimeout(()=> statusBox.style.display='none', 4000);
}

function todayISO(){
const d = new Date();
return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

/* =========================
üìä DATA (RPC + tables)
- RPC get_streak(p_user_id uuid) RETURNS int
- Table daily_checkins (user_id uuid, on_date date) unique (user_id, on_date)
========================= */
async function refreshStreak(){
const { data: { user }, error: userErr } = await sb.auth.getUser();
if (userErr || !user) return; // gate will redirect anyway

const { data, error } = await sb.rpc('get_streak', { p_user_id: user.id });
if (error){ streakEl.textContent = '‚Äì'; showStatus('Could not load streak.', 'bad'); return; }
streakEl.textContent = data ?? 0;
}

async function doCheckIn(){
checkBtn.disabled = true;
checkMsg.textContent = 'Saving‚Ä¶';

const { data: { user }, error: userErr } = await sb.auth.getUser();
if (userErr || !user){ showStatus('Not logged in.', 'bad'); checkBtn.disabled=false; return; }

const { error } = await sb
.from('daily_checkins')
.upsert({ user_id: user.id, on_date: todayISO() }, { onConflict: 'user_id,on_date' });

if (error){
checkMsg.textContent = 'Already checked in today (or error).';
} else {
checkMsg.textContent = 'Nice! Logged for today.';
confettiBurst();
await refreshStreak();
}
setTimeout(()=>{ checkMsg.textContent = 'Mark today‚Äôs check-in.'; checkBtn.disabled=false; }, 1200);
}

async function openBillingPortal(){
try {
// Replace with your endpoint that returns { url } for the portal
const res = await fetch('/api/create-subscription', { method:'POST' });
const j = await res.json();
if (j?.url) location.href = j.url;
else showStatus('Could not open billing portal.', 'bad', true);
}catch(e){ showStatus('Billing portal error.', 'bad', true); }
}

async function doLogout(e){
e?.preventDefault();
await sb.auth.signOut();
location.href = '/login.html';
}

/* =========================
üîê AUTH + TIER GATE
========================= */
async function ensurePlatinum(){
// must be logged in
const { data: { user }, error: userErr } = await sb.auth.getUser();
if (userErr || !user){
location.href = '/login.html?redirect=/platinum/index.html';
return false;
}

// must be platinum
const { data: profile, error: profErr } = await sb
.from('profiles').select('tier').eq('id', user.id).single();

if (profErr){
showStatus('Could not load your profile. Please try again.', 'bad', true);
return false;
}

if (!profile || profile.tier !== 'platinum'){
document.body.innerHTML =
`<main style="max-width:720px;margin:48px auto;padding:24px;color:#eaf2ff;">
<h2>Your account is not Platinum.</h2>
<p><a class="btn btn-primary" href="/join/platinum.html">Upgrade to Platinum</a> to access this dashboard.</p>
</main>`;
return false;
}
return true;
}

/* =========================
üéõÔ∏è WIRE CONTROLS
========================= */
function wire(){
checkBtn.addEventListener('click', doCheckIn);
billingBtn.addEventListener('click', openBillingPortal);
logoutBtn.addEventListener('click', doLogout);
// Customize your 1:1 link:
bookBtn.href = 'https://calendly.com/YOUR_HANDLE/biweekly-review';
bookBtn.textContent = 'Book 1:1 Review';
}

/* =========================
üöÄ BOOT
========================= */
window.addEventListener('DOMContentLoaded', async () => {
try{
const ok = await ensurePlatinum();
if (!ok) return;

wire();
await refreshStreak();
showStatus('Platinum user logged in ‚Äî dashboard unlocked!', 'ok');
}catch(err){
console.error('Init error:', err);
showStatus('Init error: ' + (err.message || err), 'bad', true);
}
});

/* =========================
üéâ tiny confetti (no deps)
========================= */
(function(){
const c=document.getElementById('fx'), ctx=c.getContext('2d');
let w,h,pieces=[], N=120;
const colors=['#6e93ff','#a7f38d','#7bcfbe','#ffe68a','#c7d2fe','#00e0bb','#ffb703','#ffd166'];

function resize(){ w=c.width=window.innerWidth; h=c.height=window.innerHeight; }
function rand(a,b){ return Math.random()*(b-a)+a; }
function burst(){
pieces.length=0;
for(let i=0;i<N;i++){
pieces.push({ x:w/2,y:h/3, r:rand(2,5), vx:rand(-4,4), vy:rand(-6,-2), g:0.18, c:colors[i%colors.length], a:1 });
}
requestAnimationFrame(draw);
}
function draw(){
ctx.clearRect(0,0,w,h);
let alive=false;
for(const p of pieces){
p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.a*=0.985;
if (p.a>0 && p.y<h+10){ alive=true; ctx.globalAlpha=p.a; ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }
}
ctx.globalAlpha=1;
if (alive) requestAnimationFrame(draw);
}
window.addEventListener('resize', resize, { passive:true });
resize();
window.confettiBurst = burst;
})();

// Surface JS errors on the page so this never silently blanks
window.addEventListener('error', (e)=>{
showStatus(`Error: ${e.message}`, 'bad', true);
console.error(e.message, e.error);
});
window.addEventListener('unhandledrejection', (e)=>{
const msg = e?.reason?.message || e?.reason || 'Unknown promise error';
showStatus(`Promise Error: ${msg}`, 'bad', true);
console.error(e);
});
</script>
</body>
</html>

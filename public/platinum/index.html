<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Platinum Dashboard · Operation Remoralization</title>

<!-- (optional) fonts + your styles go here -->
<style>
:root{ --bg:#0f1220; --card:#1c2233; --text:#eaf2ff; --muted:#9fb3c8; --accent:#00e6b0; }
html,body{height:100%}
body{margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:var(--text); background:#0f1220;}
.wrap{max-width:1024px; margin:48px auto; padding:0 20px;}
.card{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:24px; box-shadow:0 30px 80px rgba(0,0,0,.45)}
h1{margin:0 0 18px; font-weight:800}
.note{color:var(--muted)}
.row{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
.btn{display:inline-block; padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.15); text-decoration:none; font-weight:700}
.btn-primary{background:var(--accent); color:#00241e; border-color:transparent}
.btn-ghost{background:transparent; color:var(--text)}
.btn-danger{background:#d62d20}
.right{margin-left:auto}
#status{display:none; margin-bottom:16px}
pre.error{white-space:pre-wrap; color:#ffb4b4; background:#2a0f12; padding:12px; border-radius:8px; border:1px solid #702; }
</style>

<!-- Supabase v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
<div class="card">
<h1>Platinum Dashboard</h1>
<p class="note">Track your streaks, check in daily, book your 1:1, and manage billing.</p>

<div id="status" class="note"></div>

<div class="row" style="margin:18px 0">
<div><b>Daily Micro Check-Ins</b></div>
<button id="checkinBtn" class="btn btn-primary">Mark today’s check-in</button>
<span id="checkinMsg" class="note"></span>
<div class="right">
<a id="billingBtn" class="btn btn-ghost" href="#">Open Billing Portal</a>
<a id="logoutBtn" class="btn btn-danger" href="#">Log out</a>
</div>
</div>

<div class="row">
<div><b>Current streak:</b> <span id="streak">–</span> <span class="note">days</span></div>
</div>
</div>
</div>

<script>
// ==== 1) CONFIG – replace with your real values (no extra spaces/newlines) ====
const SUPABASE_URL = 'https://qsvelfkcaaxqgaewwwog.supabase.co'.trim(); // <-- your Project URL
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ'.trim(); // <-- your anon public key

// Guard against common copy/paste issues
if (!/^https?:\/\//.test(SUPABASE_URL)) {
throw new Error('Supabase URL is not a valid http(s) URL. Double-check copy/paste.');
}
if (!SUPABASE_ANON || SUPABASE_ANON.length < 20) {
throw new Error('Supabase anon key looks empty/short. Paste the full key.');
}

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// Small helpers
const $ = sel => document.querySelector(sel);
const showStatus = (html, tone = 'ok', sticky = false) => {
const box = $('#status');
if (!box) return;
box.style.display = 'block';
box.innerHTML = html;
if (!sticky) setTimeout(() => { box.style.display = 'none'; }, 4000);
};

// ==== 2) PAGE GUARD – must be logged in & platinum ====
async function requirePlatinum() {
// session
const { data: { user }, error: userErr } = await sb.auth.getUser();
if (userErr || !user) {
// bounce to login and return here after login
location.href = '/login.html?redirect=%2Fplatinum%2Findex.html';
return null;
}

// profile.tier
const { data: profile, error: profErr } = await sb
.from('profiles')
.select('tier')
.eq('id', user.id)
.single();

if (profErr) {
showStatus(`<pre class="error">Could not load your profile.\n${profErr.message || profErr}</pre>`, 'bad', true);
throw profErr;
}

if (!profile || profile.tier !== 'platinum') {
showStatus(
`Your account is <b>${profile?.tier || 'free'}</b>. ` +
`<a class="btn btn-ghost" href="/join/platinum.html" style="margin-left:10px">Upgrade to Platinum</a>`,
'bad',
true
);
throw new Error('Not platinum');
}

return user;
}

// ==== 3) FEATURE HOOKS (streak, check-in, billing, logout) ====
async function refreshStreak() {
const { data: { user } } = await sb.auth.getUser();
if (!user) return;
// your RPC or count query here; for now show 0 when unavailable
try {
const { data, error } = await sb.rpc('get_streak', { p_user_id: user.id });
$('#streak').textContent = error ? '0' : (data ?? 0);
} catch {
$('#streak').textContent = '0';
}
}

function todayISO() {
const d = new Date();
const m = String(d.getMonth()+1).padStart(2,'0');
const day = String(d.getDate()).padStart(2,'0');
return `${d.getFullYear()}-${m}-${day}`;
}

async function doCheckIn() {
const btn = $('#checkinBtn'); const msg = $('#checkinMsg');
btn.disabled = true; msg.textContent = 'Saving…';
try {
const { data: { user } } = await sb.auth.getUser();
const { error } = await sb
.from('daily_checkins')
.upsert({ user_id: user.id, on_date: todayISO() }, { onConflict: 'user_id,on_date' });
if (error) { msg.textContent = 'Already checked in today (or error).'; btn.disabled = false; return; }
msg.textContent = 'Nice! Logged for today.'; await refreshStreak();
setTimeout(() => { msg.textContent = ''; btn.disabled = false; }, 1200);
} catch (e) {
msg.textContent = 'Check-in failed.'; btn.disabled = false;
console.error(e);
}
}

async function openBillingPortal(e) {
e?.preventDefault?.();
showStatus('Opening billing portal…', 'ok');
// TODO: replace with your backend endpoint that returns { url }
try {
const res = await fetch('/api/billing-portal', { method: 'POST' });
const j = await res.json();
if (j?.url) location.href = j.url;
else showStatus(`<pre class="error">Billing portal not configured.</pre>`, 'bad', true);
} catch (err) {
showStatus(`<pre class="error">Billing portal error:\n${err.message || err}</pre>`, 'bad', true);
}
}

async function doLogout(e) {
e?.preventDefault?.();
await sb.auth.signOut();
location.href = '/';
}

// ==== 4) BOOT ====
window.addEventListener('DOMContentLoaded', async () => {
try {
const user = await requirePlatinum(); // redirects if not logged in
if (!user) return; // stop here after redirect

// wire controls once allowed
$('#checkinBtn')?.addEventListener('click', doCheckIn);
$('#billingBtn')?.addEventListener('click', openBillingPortal);
$('#logoutBtn')?.addEventListener('click', doLogout);

await refreshStreak();
console.log('Platinum user logged in, dashboard unlocked.');
} catch (err) {
// If guard throws (not platinum, profile error), keep the message visible
console.error('Init error:', err);
}
});

// ==== 5) Visible crash catcher (handy during setup) ====
window.addEventListener('error', (e) => {
document.body.insertAdjacentHTML('beforeend',
`<pre class="error">Error: ${e.message}</pre>`);
});
window.addEventListener('unhandledrejection', (e) => {
document.body.insertAdjacentHTML('beforeend',
`<pre class="error">Promise Error: ${e.reason?.message || e.reason}</pre>`);
});
</script>
</body>
</html>

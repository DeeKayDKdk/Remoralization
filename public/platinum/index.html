<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Platinum Dashboard</title>
<style>
body{margin:0;background:#0f1220;color:#eaf2ff;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
main{max-width:860px;margin:48px auto;padding:24px}
.card{background:#1b2436;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:20px;margin-bottom:16px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.btn{display:inline-block;padding:10px 14px;border-radius:8px;text-decoration:none;border:1px solid rgba(255,255,255,.15);color:#111;background:#f2a355;font-weight:700}
.ghost{background:transparent;color:#eaf2ff}
.status{white-space:pre-wrap;background:#101626;border-left:4px solid #6ea8fe;padding:12px;border-radius:8px;margin:12px 0}
.bad{border-left-color:#ff6b6b}
.ok{border-left-color:#2ea35c}
</style>
</head>
<body>
<main>
<h1>Platinum Dashboard</h1>
<div id="status" class="status">Loadingâ€¦</div>

<div class="card">
<h3>Daily check-in</h3>
<p id="checkMsg">Mark todayâ€™s check-in to keep your streak.</p>
<div class="row">
<button id="checkBtn" class="btn">Check in for today</button>
<span>Current streak: <strong id="streak">â€“</strong> days</span>
</div>
</div>

<div class="card">
<h3>Manage</h3>
<div class="row">
<a id="billingBtn" class="btn ghost" href="#">Open Billing Portal</a>
<a id="logoutBtn" class="btn ghost" href="#">Log out</a>
</div>
</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ---- ðŸ”§ Put your public Supabase values here (from Vercel NEXT_PUBLIC_*) ----
const SUPABASE_URL = "https://qsvelfkcaaxqgaewwwog.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ";

const el = (id) => document.getElementById(id);
const statusBox = el('status');
const say = (msg, tone='') => { statusBox.textContent = msg; statusBox.className = 'status ' + tone; };

(async () => {
try {
if (!/^https?:\/\//.test(SUPABASE_URL)) throw new Error('SUPABASE_URL invalid. Set it in platinum/index.html.');
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// 1) Session check
say('Checking sessionâ€¦');
const { data: { user }, error: uerr } = await sb.auth.getUser();
if (uerr) throw new Error('auth.getUser error: ' + uerr.message);

if (!user) {
say('No session. Redirecting to loginâ€¦');
location.href = '/login.html?redirect=/platinum/index.html';
return;
}

// 2) Tier check
say('Fetching profile/tierâ€¦');
const { data: profile, error: perr } = await sb
.from('profiles').select('tier').eq('id', user.id).single();

if (perr) throw new Error('profiles select error: ' + perr.message);

if (!profile || profile.tier !== 'platinum') {
say('Your account is not Platinum. Redirectingâ€¦', 'bad');
setTimeout(() => location.href = '/join/platinum.html', 900);
return;
}

say('Welcome, Platinum member! âœ…', 'ok');

// 3) Wire UI
el('logoutBtn').addEventListener('click', async (e) => {
e.preventDefault();
await sb.auth.signOut();
location.href = '/login.html';
});

el('billingBtn').addEventListener('click', async (e) => {
e.preventDefault();
try {
const res = await fetch('/api/create-subscription', { method:'POST' });
const j = await res.json();
if (j?.url) location.href = j.url; else say('Billing portal error.', 'bad');
} catch(err) { say('Billing portal error: ' + err.message, 'bad'); }
});

const todayISO = () => {
const d = new Date();
return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
};

async function refreshStreak() {
try {
const { data, error } = await sb.rpc('get_streak', { p_user_id: user.id });
if (error) throw error;
el('streak').textContent = data ?? 0;
} catch(err) {
el('streak').textContent = 'â€“';
say('Could not load streak: ' + (err.message || err), 'bad');
}
}

el('checkBtn').addEventListener('click', async () => {
el('checkBtn').disabled = true;
el('checkMsg').textContent = 'Savingâ€¦';
try {
const { error } = await sb
.from('daily_checkins')
.upsert({ user_id: user.id, on_date: todayISO() }, { onConflict: 'user_id,on_date' });
if (error) throw error;
el('checkMsg').textContent = 'Logged for today. Nice!';
await refreshStreak();
} catch(err) {
el('checkMsg').textContent = 'Already checked in today (or error).';
} finally {
setTimeout(() => { el('checkMsg').textContent = 'Mark todayâ€™s check-in to keep your streak.'; el('checkBtn').disabled = false; }, 1200);
}
});

await refreshStreak();

} catch (err) {
console.error(err);
say('Init error: ' + (err.message || err), 'bad');
}
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Platinum Dashboard ¬∑ Operation Remoralization</title>

<!-- fonts / minimal styles (yours, trimmed for brevity) -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1220;--card:#1c2233;--ring:#e2e8f0;--shadow:0 30px 80px rgba(0,0,0,.45)}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:#0f1220;color:#eaf2ff;font:16px/1.5 "Plus Jakarta Sans",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1024px;margin:48px auto;padding:0 20px}
.card{background:rgba(255,255,255,.04);border:1px solid var(--ring);border-radius:14px;box-shadow:var(--shadow);padding:28px}
.title{margin:0 0 8px;font-weight:800;font-size:34px}
.subtitle{margin:8px 0 20px;opacity:.75}
.grid{display:grid;gap:16px;grid-template-columns:1fr 1fr;margin-top:20px}
@media (max-width:860px){.grid{grid-template-columns:1fr}}
.kpi{display:flex;gap:14px;align-items:baseline}
.kpi h3{margin:0;font-size:20px;letter-spacing:.5px}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;border:1px solid var(--ring);text-decoration:none;font-weight:700}
.btn-primary{background:#2c41ea;color:#fff;border-color:#3a52e0}
.btn-ghost{background:transparent;color:#fff}
.btn-danger{background:#c21a1a;color:#fff;border-color:#8a2020}
.row{display:flex;gap:12px;align-items:center;margin-top:12px}
.note{font-size:.95rem;opacity:.8}
.box{display:none;margin-top:12px;padding:12px;border-radius:10px;border:1px dashed #7a86a5;background:rgba(255,255,255,.06)}
.ok{color:#9DFF90}.bad{color:#ff9c9c}
canvas#fx{position:fixed;inset:0;pointer-events:none}
</style>
</head>
<body>
<canvas id="fx"></canvas>

<div class="wrap">
<div class="card">
<div class="title">PLATINUM DASHBOARD</div>
<p class="subtitle">Track your streaks, check in daily, book your 1:1, and manage billing ‚Äî all in one place.</p>

<!-- status / messages -->
<div id="status" class="box"></div>

<div class="grid">
<!-- LEFT -->
<div>
<div class="kpi">
<h3>Current streak</h3>
<span id="streak">‚Äì</span><span>days</span>
</div>

<div class="row">
<button id="checkinBtn" class="btn btn-primary">Mark today‚Äôs check-in</button>
<span id="checkinMsg" class="note"></span>
</div>

<p class="note">Tip: one tap a day keeps momentum alive. We only count 1 check-in per day.</p>
</div>

<!-- RIGHT -->
<div>
<h3>Quick Actions</h3>
<div class="row"><a class="btn btn-ghost" id="book1to1" target="_blank">Book 1:1 Review</a></div>
<div class="row"><a class="btn btn-ghost" href="mailto:support@yourdomain.com">Contact Support</a></div>
<div class="row"><a class="btn btn-ghost" href="/platinum/challenges.html">View Challenges</a></div>
<div class="row"><a class="btn btn-ghost" href="/platinum/resources.html">Open Resources</a></div>
<div class="row"><a class="btn btn-ghost" href="/platinum/community.html"><em>Enter Community</em></a></div>

<div class="row" style="margin-top:12px">
<button id="billingBtn" class="btn btn-ghost">Open Billing Portal</button>
<a id="logoutBtn" class="btn btn-danger right" href="#">Log out</a>
</div>
</div>
</div>
</div>
</div>

<!-- Supabase (browser) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// üîë 1) PUT YOUR REAL VALUES HERE (from Supabase ‚Üí Settings ‚Üí API)
const SUPABASE_URL = "https://qsvelfkcaaxqgaewwwog.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ";

// safety check (prevents the ‚ÄúInvalid supabaseUrl‚Äù error)
if (!/^https?:\/\//i.test(SUPABASE_URL)) {
document.body.innerHTML = "<pre style='color:#ff7b7b'>Config error: SUPABASE_URL is not a valid http(s) URL.</pre>";
throw new Error("SUPABASE_URL invalid");
}

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Element refs
const statusBox = document.getElementById('status');
const streakEl = document.getElementById('streak');
const checkBtn = document.getElementById('checkinBtn');
const checkMsg = document.getElementById('checkinMsg');
const logoutBtn = document.getElementById('logoutBtn');
const billingBtn = document.getElementById('billingBtn');
const bookBtn = document.getElementById('book1to1');

// Config (customize)
bookBtn.href = "https://calendly.com/YOUR_HANDLE/biweekly-review";

// Helpers
function showStatus(html, tone="ok", sticky=false){
statusBox.style.display = "block";
statusBox.innerHTML = `<span class="${tone==='ok'?'ok':'bad'}">‚óè</span> <span class="note">${html}</span>`;
if (!sticky) setTimeout(()=>{ statusBox.style.display="none"; }, 4000);
}
function todayISO(){
const d=new Date(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
return `${d.getFullYear()}-${m}-${day}`;
}

// RPC + table expectations:
// - RPC get_streak(p_user_id uuid) RETURNS int
// - Table daily_checkins with unique (user_id, on_date)

async function refreshStreak(){
const { data: { user } } = await sb.auth.getUser();
if (!user) return;
const { data, error } = await sb.rpc('get_streak', { p_user_id: user.id });
if (error){ streakEl.textContent = "‚Äì"; return; }
streakEl.textContent = data ?? 0;
}

async function doCheckIn(){
checkBtn.disabled = true;
checkMsg.textContent = "Saving‚Ä¶";
const { data: { user } } = await sb.auth.getUser();
if (!user){ checkMsg.textContent="Not logged in."; return; }
const { error } = await sb.from('daily_checkins')
.upsert({ user_id: user.id, on_date: todayISO() }, { onConflict: 'user_id,on_date' });
if (error){
checkMsg.textContent = "Already checked in today (or error).";
checkBtn.disabled = false;
return;
}
checkMsg.textContent = "Nice! Logged for today.";
confettiBurst();
await refreshStreak();
setTimeout(()=>{ checkMsg.textContent=""; checkBtn.disabled=false; }, 1200);
}

async function openBillingPortal(){
// Replace with your serverless function that returns { url }
try{
const res = await fetch("/api/create-subscription", { method:"POST" });
const j = await res.json();
if (j?.url) location.href = j.url;
else showStatus("Could not open billing portal.", "bad");
}catch(e){ showStatus("Billing portal error.", "bad"); }
}

async function doLogout(){
await sb.auth.signOut();
location.href = "/login.html";
}

function wireControls(){
checkBtn.addEventListener('click', doCheckIn);
billingBtn.addEventListener('click', openBillingPortal);
logoutBtn.addEventListener('click', (e)=>{ e.preventDefault(); doLogout(); });
}

// Auth + tier gate
async function ensurePlatinum(){
// must be logged in
const { data: { user }, error: userError } = await sb.auth.getUser();
if (userError || !user){
location.href = "/login.html?redirect=/platinum/index.html";
return false;
}
// must be platinum
const { data: profile, error: profError } = await sb
.from('profiles')
.select('tier')
.eq('id', user.id)
.single();

if (profError){
showStatus("Could not load your profile. Please try again.", "bad", true);
return false;
}
if (!profile || profile.tier !== "platinum"){
document.body.innerHTML = `
<main style="max-width:720px;margin:40px auto;padding:24px;color:#eaf2ff;">
<h2>Your account is not Platinum.</h2>
<p><a class="btn btn-primary" href="/join/platinum.html">Upgrade to Platinum</a> to access this dashboard.</p>
</main>`;
return false;
}
return true;
}

// Kickoff
window.addEventListener('DOMContentLoaded', async () => {
try{
const ok = await ensurePlatinum();
if (!ok) return;
await refreshStreak();
wireControls();
console.log("Platinum user logged in, dashboard unlocked!");
}catch(err){
console.error("Init error:", err);
showStatus(`Init error: ${err.message || err}`, "bad", true);
}
});

// tiny confetti (no deps)
(function(){
const c=document.getElementById('fx'), ctx=c.getContext('2d');
let w,h,pieces=[],N=120; const colors=["#66e3ff","#a7f30d","#bfcf8e","#fde68a","#c7d2fe","#0066bb","#ffb703","#ffd166"];
function rand(a,b){return Math.random()*(b-a)+a}
function resize(){w=c.width=innerWidth;h=c.height=innerHeight}
addEventListener('resize',resize,{passive:true}); resize();
function burst(){ pieces.length=0; for(let i=0;i<N;i++){pieces.push({x:w/2,y:h/3,r:rand(2,5),vx:rand(-4,4),vy:rand(-8,-2),col:colors[(Math.random()*colors.length)|0],a:1});} requestAnimationFrame(draw); }
function draw(){ ctx.clearRect(0,0,w,h); let alive=false; for(const p of pieces){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.15; p.a*=0.98; if(p.a>0.02 && p.y<h+10) alive=true; ctx.globalAlpha=Math.max(p.a,0.01); ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle=p.col; ctx.fill(); } ctx.globalAlpha=1; if(alive) requestAnimationFrame(draw); }
window.confettiBurst = burst;
})();

// Surface errors directly on page (handy while wiring)
window.addEventListener("error", (e)=>{ showStatus(`Error: ${e.message}`, "bad", true); console.error(e.error||e.message||e); });
window.addEventListener("unhandledrejection", (e)=>{ showStatus(`Promise Error: ${e.reason}`, "bad", true); console.error(e.reason); });
</script>
</body>
</html>

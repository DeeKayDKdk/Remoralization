<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ✅ your real values from Supabase → Project Settings → API
const SUPABASE_URL = "https://qsvelfkcaaqxgaewwwog.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ";

const s = (t)=>document.getElementById('s').textContent = t;
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const withTimeout = (promise, ms, label) =>
Promise.race([
promise,
new Promise((_, reject) => setTimeout(() => reject(new Error(`${label} timeout after ${ms}ms`)), ms))
]);

(async function main(){
try {
s("Finishing signup…");

const url = new URL(location.href);
const code = url.searchParams.get("code");
const h = new URLSearchParams(location.hash.slice(1));
const access_token = h.get("access_token");
const refresh_token = h.get("refresh_token");

if (access_token && refresh_token) {
s("Setting session from tokens…");
// ⏳ fail fast if it hangs
await withTimeout(
supabase.auth.setSession({ access_token, refresh_token }),
8000,
"setSession"
);
} else if (code) {
s("Exchanging code for session…");
await withTimeout(
supabase.auth.exchangeCodeForSession({ code }),
8000,
"exchangeCodeForSession"
);
} else {
return s("Login link missing credentials. Please open a new magic link.");
}

s("Verifying session…");
const { data: { user }, error } = await withTimeout(supabase.auth.getUser(), 6000, "getUser");
if (error) return s("Login check failed: " + error.message);
if (!user) return s("Not logged in. Please try the magic link again.");

s("Success! Redirecting…");
location.replace("/start-report.html");
} catch (e) {
// Show the actual error instead of a blank page
s("Error: " + (e?.message || String(e)));
}
})();
</script>

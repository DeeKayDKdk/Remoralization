<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finishing signupâ€¦</title>
<style>
body { font: 16px system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 20px; color: #111; }
#stage { font-weight: 700; margin: 0 0 8px; }
#url, #err { white-space: pre-wrap; word-break: break-word; background:#f7f7f7; padding:10px; border-radius:8px; }
#url { margin-bottom: 8px; }
</style>
</head>
<body>
<div id="stage">Page loaded.</div>
<div id="url"></div>
<div id="err"></div>

<!-- Show any JS error instead of a blank page -->
<script>
const stage = (t)=>document.getElementById('stage').textContent = t;
const showErr = (t)=>document.getElementById('err').textContent = String(t || '');
document.getElementById('url').textContent = 'URL: ' + location.href;
window.onerror = (msg, src, line, col, err) => {
showErr('JS error: ' + msg + '\n' + (src||'') + ':' + (line||'') + ':' + (col||'') + '\n' + (err && err.stack ? err.stack : ''));
};
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ðŸ”§ REPLACE these with your real values (Supabase â†’ Project Settings â†’ API)
const SUPABASE_URL = "https://qsvelfkcaaqxgaewwwog.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// Promise timeout helper so we surface hangs
const withTimeout = (p, ms, label) =>
Promise.race([
p,
new Promise((_, rej) => setTimeout(()=>rej(new Error(label + ' timeout after ' + ms + 'ms')), ms))
]);

(async function main(){
try {
stage('Finishing signupâ€¦');

// Show tokens we see (redact for safety)
const u = new URL(location.href);
const code = u.searchParams.get('code');
const h = new URLSearchParams(location.hash.slice(1));
const at = h.get('access_token');
const rt = h.get('refresh_token');

// Minimal redaction in the URL panel
const redact = (x)=> x ? (x.slice(0,6) + 'â€¦' + x.slice(-4)) : '(none)';
document.getElementById('url').textContent =
'URL: ' + location.href +
'\ncode=' + redact(code) +
'\naccess_token=' + redact(at) +
'\nrefresh_token=' + redact(rt);

if (at && rt) {
stage('Setting session from tokensâ€¦');
await withTimeout(supabase.auth.setSession({ access_token: at, refresh_token: rt }), 8000, 'setSession');
} else if (code) {
stage('Exchanging code for sessionâ€¦');
await withTimeout(supabase.auth.exchangeCodeForSession({ code }), 8000, 'exchangeCodeForSession');
} else {
stage('No credentials found in URL. Open a fresh magic link.');
return;
}

stage('Verifying sessionâ€¦');
const { data: { user }, error } = await withTimeout(supabase.auth.getUser(), 6000, 'getUser');
if (error) { showErr(error.message); stage('Login check failed.'); return; }
if (!user) { stage('Not logged in. Try the magic link again.'); return; }

stage('Success! Redirectingâ€¦');
location.replace('/start-report.html');
} catch (e) {
stage('Error.');
showErr(e && e.message ? e.message : String(e));
}
})();
</script>
</body>
</html>

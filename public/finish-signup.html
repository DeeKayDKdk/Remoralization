<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finishing signupâ€¦</title>
<style>
body { font: 16px system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 20px; color: #111; }
#stage { font-weight: 700; margin: 0 0 8px; }
#url, #err { white-space: pre-wrap; word-break: break-word; background:#f7f7f7; padding:10px; border-radius:8px; }
#url { margin-bottom: 8px; }
</style>
</head>
<body>
<div id="stage">Page loaded.</div>
<div id="url"></div>
<div id="err"></div>

<!-- Show any JS error instead of a blank page -->
<script>
const stage = (t)=>document.getElementById('stage').textContent = t;
const showErr = (t)=>document.getElementById('err').textContent = String(t || '');
document.getElementById('url').textContent = 'URL: ' + location.href;
window.onerror = (msg, src, line, col, err) => {
showErr('JS error: ' + msg + '\n' + (src||'') + ':' + (line||'') + ':' + (col||'') + '\n' + (err && err.stack ? err.stack : ''));
};
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ðŸ”§ put your real values here (Project Settings â†’ API)
const SUPABASE_URL = "https://qsvelfkcaaqxgaewwwog.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ";

const stage = (t)=>document.getElementById('stage')?.textContent = t;
const show = (id, t)=>{
const el = document.getElementById(id);
if (el) el.textContent = t;
};

document.getElementById('url').textContent = 'URL: ' + location.href;

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

(async function main(){
try {
const hash = new URLSearchParams(location.hash.slice(1));
const at = hash.get('access_token');
const rt = hash.get('refresh_token');

if (at && rt) {
stage('Setting session from tokensâ€¦');

const { data, error } = await supabase.auth.setSession({
access_token: at,
refresh_token: rt
});

if (error) {
stage('setSession failed');
show('err', 'setSession error: ' + error.message);
return;
} else {
show('err', 'setSession ok');
}

} else {
const code = new URL(location.href).searchParams.get('code');
if (code) {
stage('Exchanging codeâ€¦');
const { error } = await supabase.auth.exchangeCodeForSession({ code });
if (error) { stage('exchange failed'); show('err','exchange error: ' + error.message); return; }
show('err','exchange ok');
} else {
stage('No credentials found in URL.');
return;
}
}

stage('Verifying sessionâ€¦');
const { data: { user }, error } = await supabase.auth.getUser();
if (error) { stage('Login check failed'); show('err', error.message); return; }
if (!user) { stage('Not logged in. Try again.'); return; }

stage('Success! Redirectingâ€¦');
location.replace('/start-report.html');
} catch (e) {
stage('Error');
show('err', String(e?.message || e));
}
})();
</script>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finishing signupâ€¦</title>
<style>
body{font:16px system-ui, -apple-system, Segoe UI, Roboto, Arial; padding:24px}
#s{white-space:pre-wrap}
</style>
</head>
<body>
<div id="s">Finishing signupâ€¦</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ðŸ”§ FILL THESE WITH YOUR REAL VALUES (Project Settings â†’ API)
const SUPABASE_URL = "https://qsvelfkcaaqxgaewwwog.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ";

const s = (t)=>document.getElementById('s').textContent = t;
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

(async function main(){
try {
s("Finishing signupâ€¦");

// Handle BOTH magic-link styles
const url = new URL(location.href);
const code = url.searchParams.get("code"); // PKCE style
const h = new URLSearchParams(location.hash.slice(1)); // hash style
const access_token = h.get("access_token");
const refresh_token = h.get("refresh_token");

if (access_token && refresh_token) {
s("Setting session from tokensâ€¦");
const { error } = await supabase.auth.setSession({ access_token, refresh_token });
if (error) return s("Login failed: " + error.message);
} else if (code) {
s("Exchanging code for sessionâ€¦");
const { error } = await supabase.auth.exchangeCodeForSession({ code });
if (error) return s("Login failed: " + error.message);
} else {
return s("Login link missing credentials. Please open a new magic link.");
}

s("Verifying sessionâ€¦");
const { data: { user }, error } = await supabase.auth.getUser();
if (error) return s("Login check failed: " + error.message);
if (!user) return s("Not logged in. Please try the magic link again.");

// Optional: create/ensure profile (safe no-op if table/column missing will just error and continue)
try { await supabase.from("profiles").upsert({ id: user.id }); } catch {}

s("Success! Redirectingâ€¦");
location.replace("/start-report.html");
} catch (e) {
s("Unexpected error: " + String(e));
}
})();
</script>
</body>
</html>

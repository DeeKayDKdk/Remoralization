<script>
// ====== CONFIG (safe for browser) ======
const SUPABASE_URL = 'https://qsvelfkcaaqxgaewwwog.supabase.co'; // yours
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ'; // yours
const STRIPE_PUBLISHABLE_KEY = 'pk_live_51KQiEQEAIfxpksnpRrLuZnv59jHo2nGBILCc9ojzCrODM5QsPdznCtsiTWdwOpeo1MhVpZSdPjfe2ce5vyeXPLZ000UXBLFb9o'; // your pk_

// ====== INIT CLIENTS ======
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

const paymentForm = document.getElementById('payment-form');
const paymentMsg = document.getElementById('payment-message');

let elements; // Stripe Elements instance
let customerId; // from /api/create-setup-intent

const showMsg = (t='') => { paymentMsg.style.display='block'; paymentMsg.textContent=t; };
const clearMsg = () => { paymentMsg.style.display='none'; paymentMsg.textContent=''; };

async function getEmail() {
try {
const { data } = await supabase.auth.getUser();
return (data?.user?.email) || '';
} catch { return ''; }
}

// ---- Step 1: create SetupIntent + mount Payment Element ----
async function init() {
clearMsg();

const email = await getEmail(); // optional
const res = await fetch('/api/create-setup-intent', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ email })
});

const data = await res.json();
if (!res.ok || !data.clientSecret) {
return showMsg(data.error || 'Failed to initialize payment.');
}

customerId = data.customerId;

elements = stripe.elements({
clientSecret: data.clientSecret,
appearance: { theme: 'night' }
});

const paymentElement = elements.create('payment');
paymentElement.mount('#payment-element');
}

// ---- Step 2: confirm SetupIntent → create subscription → (maybe) confirm 3DS ----
paymentForm.addEventListener('submit', async (e) => {
e.preventDefault();
clearMsg();

// 2a) Confirm Setup to get a reusable payment method
const { setupIntent, error } = await stripe.confirmSetup({
elements,
confirmParams: { return_url: window.location.href },
redirect: 'if_required'
});
if (error) return showMsg(error.message || 'Could not confirm card.');

const paymentMethodId = setupIntent.payment_method;

// 2b) Create the subscription server-side
const subRes = await fetch('/api/create-subscription', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ customerId, paymentMethodId })
});
const subData = await subRes.json();
if (!subRes.ok) return showMsg(subData.error || 'Subscription creation failed.');

// 2c) If Stripe requires 3DS for the first invoice, finish it now
if (subData.clientSecret) {
const pi = await stripe.confirmCardPayment(subData.clientSecret);
if (pi.error) return showMsg(pi.error.message || '3D Secure failed.');
}

// 2d) Success
window.location.href = '/success.html';
});

// Kick things off
document.addEventListener('DOMContentLoaded', init);
</script>

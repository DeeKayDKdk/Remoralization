<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Join Operation Remoralization</title>

<link rel="stylesheet" href="/style.css" />
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://js.stripe.com/v3/"></script>

<style>
main { width:min(720px, 96%); margin:48px auto; padding:24px; text-align:center; }
#payment-form { margin-top:16px; display:inline-block; width:min(520px, 100%); text-align:left; }
#payment-message { display:none; margin-top:12px; }
</style>
</head>
<body>
<main>
<h1 class="brand-title">Join Operation Remoralization ($10/month)</h1>
<p>Your subscription is processed securely on this page.</p>

<form id="payment-form">
<div id="payment-element"></div>
<button id="submit" class="btn btn-primary" style="margin-top:16px;" type="submit">Join Platinum</button>
<div id="payment-message" class="msg err"></div>
</form>

<p class="back" style="margin-top:16px;"><a class="btn btn-ghost" href="/join.html">Back</a></p>
</main>

<script>
// ---- PUBLIC KEYS (safe for the browser) ----
const SUPABASE_URL = 'https://qsvelfkcaaqxgaewwwog.supabase.co';
const SUPABASE_ANON_KEY= 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzdmVsZmtjYWFxeGdhZXd3d29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODUwNDYsImV4cCI6MjA3MjU2MTA0Nn0.kBZLf09JYQQNK-2xsJs5mj2m43q8bHgVs2jEZvObkMQ';
const STRIPE_PUBLISHABLE_KEY = 'pk_live_51KQiEQEAIfxpksnpRrLuZnv59jHo2nGBILCc9ojzCrODM5QsPdznCtsiTWdwOpeo1MhVpZSdPjfe2ce5vyeXPLZ000UXBLFb9o';

// Init clients
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

const paymentForm = document.getElementById('payment-form');
const paymentMsg = document.getElementById('payment-message');
let elements;

function showMsg(t){ paymentMsg.style.display='block'; paymentMsg.textContent=t; }
function clearMsg(){ paymentMsg.style.display='none'; paymentMsg.textContent=''; }

async function getEmail() {
try {
const { data } = await supabase.auth.getUser();
return data?.user?.email || '';
} catch { return ''; }
}

async function initPaymentElement() {
const email = await getEmail();

// 1) Ask our server to create a subscription and return a PaymentIntent client_secret
const r = await fetch('/api/create-subscription', {
method: 'POST',
headers: { 'Content-Type':'application/json' },
body: JSON.stringify({ email })
});
const data = await r.json();
if (!data.clientSecret) throw new Error(data.error || 'No client secret');

// 2) Mount the Payment Element
elements = stripe.elements({ clientSecret: data.clientSecret });
const paymentElement = elements.create('payment');
paymentElement.mount('#payment-element');
}

initPaymentElement().catch(e => showMsg(e.message || 'Failed to load payment form'));

paymentForm.addEventListener('submit', async (e) => {
e.preventDefault(); // stay on page
clearMsg();

const { error } = await stripe.confirmPayment({
elements,
redirect: 'if_required' // <-- must be singular "redirect"
});

if (error) return showMsg(error.message || 'Payment failed');
window.location.href = '/success.html';
});
</script>
</body>
</html>

<script src="https://js.stripe.com/v3/"></script>
<script>
// Itâ€™s okay to hardcode your publishable key here (never the secret key)
const stripe = Stripe('pk_live_51KQiEQEAIfxpksnpRrLuZnv59jHo2nGBILCc9ojzCrODM5QsPdznCtsiTWdwOpeo1MhVpZSdPjfe2ce5vyeXPLZ000UXBLFb9o'); // your PUBLISHABLE key

let elements, customerId, paymentElement;

function showErr(msg) {
document.getElementById('error').textContent = msg || '';
}

async function init() {
showErr('');

// 1) Create SetupIntent (+ Customer) on the server
const email = (document.getElementById('email1')?.value || '').trim() || undefined;
const res = await fetch('/api/create-setup-intent', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ email })
});
const data = await res.json();
if (!res.ok || !data.clientSecret) return showErr(data.error || 'Failed to initialize payment.');

customerId = data.customerId;

// 2) Mount Payment Element
elements = stripe.elements({ clientSecret: data.clientSecret, appearance: { theme: 'night' } });
paymentElement = elements.create('payment');
paymentElement.mount('#payment-element');
}

async function onSubmit(e) {
e.preventDefault();
showErr('');

// 3) Confirm Setup to get a reusable payment method
const { setupIntent, error } = await stripe.confirmSetup({
elements,
confirmParams: {
return_url: window.location.href // not used because we handle "if_required"
},
redirect: 'if_required'
});
if (error) return showErr(error.message);

const paymentMethodId = setupIntent.payment_method;

// 4) Create subscription on the server
const subRes = await fetch('/api/create-subscription', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ customerId, paymentMethodId })
});
const subData = await subRes.json();
if (!subRes.ok) return showErr(subData.error || 'Subscription creation failed.');

// 5) If first invoice needs 3DS, finish it on-page
if (subData.clientSecret) {
const pi = await stripe.confirmCardPayment(subData.clientSecret);
if (pi.error) return showErr(pi.error.message);
}

// 6) Success
window.location.href = '/success.html';
}

document.addEventListener('DOMContentLoaded', () => {
// Wire the button by id="submit"
document.getElementById('submit')?.addEventListener('click', onSubmit);
// Initialize once page is ready
init();
});
</script>
